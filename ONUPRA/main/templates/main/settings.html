{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="shortcut icon" type="image/png" href="{% static 'main/favicon.ico' %}">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="{% static 'main/css/registration.css' %}">
    <link href='https://unpkg.com/boxicons@2.1.1/css/boxicons.min.css' rel='stylesheet'>
</head>
<body style="background-color: #91bfbc">
    <a href="{% url 'you' %}"><i class='bx bx-arrow-back'></i></a>
        <div class="registration_set">
            <span class="header_span">Настройки профиля</span>

            <div class="field" id="form_nickname">
            <form class="form_nickname" id="nickname">
                <input type="text" class="input_regestration_user" name="" id="username" value="{{ request.user.username }}">
                <input type="submit" id="user_submit" class="unput_submit_nickname" value="~">
            </form>    
            <span class="error err email-error">
                <i class="bx bx-error-circle error-icon"></i>
                <p class="error-text">Имя пользователя занято или он не соответствует требованиям</p>
            </span>
            <span class="error err2 email-error">
                <i class="bx bx-error-circle error-icon"></i>
                <p class="error-text">Имя пользователя не соответствует требованиям (Размер 3-16)</p>
            </span>
            <span class="error err3 email-error">
                <i class="bx bx-error-circle error-icon"></i>
                <p class="error-text">Заполните свой никнейм</p>
            </span>
            <span class="success succ">
                <i class="bx bx-error-circle error-icon"></i>
                <p class="error-text">Никнейм успешно изменён</p>
            </span>
            <span class="success succ1">
                <i class="bx bx-error-circle error-icon"></i>
                <p class="error-text">Никнейм свободен</p>
            </span>
            </div>
            <form class="list_settings w_1 inactive_1" id="email">
                <div class="list_settings__change a_1">
                    <span>Редактировать почту</span>
                    <i class='bx bx-right-arrow-alt bx-right-arrow-alt1' style="transform: rotate(0deg); transition: 0.3s; color: rgb(113, 112, 112);"></i>
                </div>
                <div id="oppacty1" style="transition: 0.4s; opacity: 0;">
                    <div class="input_mail input_set field-icon" id="form_mail">
                        <span>Новая почта</span>
                        <input type="text" class="input_regestration" id="const_email" value="{{ request.user.email }}">
                        <span class="error-absolute err email-error err-0">
                            <i class="bx bx-error-circle error-icon"></i>
                        </span>
                        <span data-info="Электронная почта не подходит по требованиям, примерная формуа - (onupra@gmail.com)" class="error-absolute err2 email-error err-0">
                            <i title="Электронная почта не подходит по требованиям, примерная формуа - (onupra@gmail.com)" class="bx bx-error-circle error-icon"></i>
                            <!-- <p class="error-text">Электронная почта не подходит по требованиям</p> -->
                        </span>
                        <span data-info="Введите вашу почту!" class="error-absolute err3 email-error err-0">
                            <i class="bx bx-error-circle error-icon"></i>
                            <!-- <p class="error-text">Введите вашу почту!</p> -->
                        </span>
                        <span data-info="Почта успешна изменена" class="succ-absolute succ email-error succ-0">
                            <i class="bx bx-error-circle error-icon"></i>
                            <!-- <p class="error-text">Неправильный пароль</p> -->
                        </span>
                    </div>
                    <div class="input_password_repeat field-icon input_set" id="form_mail_password">
                        <span>Введите ваш пароль</span>
                        <div class="password-relative">
                            <input type="password" class="input_regestration" id="email_password">
                            <i class='bx bx-hide show-hide'></i>
                        </div>
                        <span data-info="Пароль неверный" class="error-absolute err err-0">
                            <i class="bx bx-error-circle error-icon"></i>
                        </span>
                    </div>
                    <input type="submit" id="email_submit" class="button_submit_settings d-settings_1" value="Сохранить">
                </div>
            </form>


            <form class="list_settings w_2 inactive_2" id="password">
                <div class="list_settings__change a_2">
                    <span>Редактировать пароль</span>
                    <i class='bx bx-right-arrow-alt bx-right-arrow-alt2' style="transform: rotate(0deg);  transition: 0.2s; color: rgb(113, 112, 112);" ></i>
                </div>

                <div id="oppacty2" style="transition: 0.4s; opacity: 0;">
                    <div class="input_password_repeat input_set field-icon" id="passwordValue">
                        <span>Введите ваш пароль</span>
                        <i class='bx bx-hide show-hide'></i>
                        <input type="password" class="input_regestration" id="const_password">
                        <span data-info="Пароль неверный" class="error-absolute err email-error err-0">
                            <i class="bx bx-error-circle error-icon"></i>
                            <!-- <p class="error-text">Неправильный пароль</p> -->
                        </span>
                    </div>
                    <div class="input_password_now input_set field-icon" id="passwordValueNew">
                        <span>Введите ваш новый пароль</span>
                        <i class='bx bx-hide show-hide'></i>
                        <input type="password" class="input_regestration" id="password_new">
                        <span data-info="Пароль не подходит по требованиям (Должны использоваться цифры(0-9), Латиница заглавные и прописные(A-Za-z))" class="err-0 error-absolute err2 email-error">
                            <i  class="bx bx-error-circle error-icon"></i>
                            <!-- <p class="error-text">Пароль не подходит по требованиям</p> -->
                        </span>
                        <span data-info="Введите ваш пароль!" class="error-absolute err3 email-error err-0">
                            <i class="bx bx-error-circle error-icon"></i>
                            <!-- <p class="error-text">Введите ваш пароль!</p> -->
                        </span>
                    </div>
                    <div class="input_password_now_repeat input_set field-icon" id="CpasswordValueNew">
                        <span>Повторите ваш новый пароль</span>
                        <i class='bx bx-hide show-hide'></i>
                        <input type="password" class="input_regestration" id="Cpassword_new">
                        <span data-info="Пароли не совпадают" class="err-0 error-absolute err2 email-error">
                            <i  class="bx bx-error-circle error-icon"></i>
                            <!-- <p class="error-text">Пароли не совпадают</p> -->
                        </span>
                        <span data-info="Введите ваш пароль!" class="error-absolute err3 email-error err-0">
                            <i class="bx bx-error-circle error-icon"></i>
                            <!-- <p class="error-text">Повторите свой пароль!</p> -->
                        </span>
                    </div>
                </div>
                    <input type="submit" id="password_submit" class="button_submit_settings d-settings" value="Сохранить">
            </form>

            <div class="line"></div>

            <button class="delete_account open-popup">Удалить аккаунт</button>
        </div>

        <div class="popup__bg"> 
            <form class="popup" id="delete">
                <i class='bx bx-x close-popup'></i>

                <p></p>
                <p></p>
                <div class="input_password_repeat field" id="delete_invalid">
                    <span>Подтвердите свой пароль</span>
                    <i class='bx bx-hide show-hide'></i>
                    <input type="password" class="input_proverka input_regestration" id="delete_password">
                    <span class="error err3 email-error">
                        <i class="bx bx-error-circle error-icon"></i>
                        <p class="error-text"> Неверный пароль</p>
                    </span>
                </div>

                <button type="submit">Удалить аккаунт</button>
            </form>
        </div>
    <script src="{% static 'main/js/settings.js' %}"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        var initial;
function checkUsers(){
    if (true) 
    {
        form_nickname.classList.remove("invalid");
        form_nickname.classList.remove("invalid2");
        form_nickname.classList.remove("invalid3");
        form_nickname.classList.remove("successfully");
        form_nickname.classList.remove("successfully1");
        const usersPattern = /^[a-яА-Яa-zA-Z0-9!"#$%&')(*+,-./:;<=>?@^_`|]{3,20}$/;
        if (username.value === ''){
            form_nickname.classList.remove("successfully");
            form_nickname.classList.remove("invalid");
            form_nickname.classList.remove("invalid2");
            form_nickname.classList.remove("successfully1");
            return form_nickname.classList.add("invalid3"); }
        if (!username.value.match(usersPattern)){
            form_nickname.classList.remove("successfully");
            form_nickname.classList.remove("successfully1");
            form_nickname.classList.remove("invalid");
            form_nickname.classList.remove("invalid3");
            return form_nickname.classList.add("invalid2");
            } 
       
        if (true) 
        {
            function initialon(){
                initial = window.setTimeout(() => {  
             if (true) 
             
        {
            $(document).ready(function() {            
                // get name input value
                const name = $('#username').val();
                // create AJAX request
                $.ajax({
                    type: 'POST',
                    url: '',
                    headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                    },
                    data: {
                    'username': name,
                    'check_username': true
                    },
                    dataType: 'json',
                    success: function(response) {
                        const form_nickname = document.getElementById("form_nickname");
                        const username = document.getElementById("username");
                        if (response.successfully == false){
                            form_nickname.classList.remove("invalid2");
                            form_nickname.classList.remove("invalid3");
                            form_nickname.classList.remove("successfully");
                            form_nickname.classList.remove("successfully1");
                            return form_nickname.classList.add("invalid");
                        }
                        else {
                            username.value = response.username;
                            form_nickname.classList.remove("invalid");
                            form_nickname.classList.remove("invalid2");
                            form_nickname.classList.remove("invalid3");
                            form_nickname.classList.remove("successfully1");
                            return form_nickname.classList.add("successfully1");
                        }
                    },
                //   error: function(response) {
                //     console.log('Error:', response);
                //   }
                });
                });
            // if (
            //     !form_nickname.classList.contains("invalid") &&
            //     !form_nickname.classList.contains("invalid2") &&
            //     !form_nickname.classList.contains("invalid3")
            // ) {
            //     form_nickname.classList.remove("invalid");
            //     form_nickname.classList.remove("invalid2");
            //     form_nickname.classList.remove("invalid3");
            //     return true
            // } 
            }}, 500);
            }
            
            initialon();
        }}};

function initialclearTimeout()
{
    clearTimeout(initial);
}
username.addEventListener("keyup", initialclearTimeout);
username.addEventListener("keyup", () => {
    checkUsers();
});
        $(document).ready(function() {
            // add event listener for form submit
            $('#nickname').submit(function(e) {
            e.preventDefault(); // prevent default form submission behavior
        
            // get name input value
            const name = $('#username').val();
        
            // create AJAX request
            $.ajax({
                type: 'POST',
                url: '',
                headers: {
                'X-CSRFToken': '{{ csrf_token }}'
                },
                data: {
                'username': name,
                'username_edit': true
                },
                dataType: 'json',
                success: function(response) {
                    const form_nickname = document.getElementById("form_nickname");
                    const username = document.getElementById("username");
                    if (response.successfully == false){
                        form_nickname.classList.remove("successfully");
                        form_nickname.classList.remove("successfully1");
                        form_nickname.classList.remove("invalid2");
                        form_nickname.classList.remove("invalid3");
                        form_nickname.classList.add("invalid");
                    }
                    else {
                        username.value = response.username;
                        form_nickname.classList.remove("invalid");
                        form_nickname.classList.remove("invalid2");
                        form_nickname.classList.remove("invalid3");
                        form_nickname.classList.remove("successfully1");
                        form_nickname.classList.add("successfully")
                    }
                },
            //   error: function(response) {
            //     console.log('Error:', response);
            //   }
            });
            });

            // add event listener for form submit
            $('#email').submit(function(e) {
            e.preventDefault(); // prevent default form submission behavior
        
            // get email input value
            const email = $('#const_email').val();
            const password = $('#email_password').val();
        
            // create AJAX request
            $.ajax({
                type: 'POST',
                url: '',
                headers: {
                'X-CSRFToken': '{{ csrf_token }}'
                },
                data: {
                'email': email,
                'password': password,
                'email_edit': true
                },
                dataType: 'json',
                success: function(response) {
                },
            //   error: function(response) {
            //     console.log('Error:', response);
            //   }
            });
            });

            // add event listener for form submit
            $('#password').submit(function(e) {
            e.preventDefault(); // prevent default form submission behavior
        
            // get passwords input value
            const old_password = $('#const_password').val();
            const new_password = $('#password_new').val();
            const new_password2 = $('#Cpassword_new').val();
        
            // create AJAX request
            $.ajax({
                type: 'POST',
                url: '',
                headers: {
                'X-CSRFToken': '{{ csrf_token }}'
                },
                data: {
                'old_password': old_password,
                'new_password': new_password,
                'new_password2': new_password2,
                'password_edit': true
                },
                dataType: 'json',
                success: function(response) {
                    if (response.successfully == false){
                        passwordValue.classList.add("invalid");
                    } else{
                        window.location.href = "{% url 'login' %}";
                    }
                },
            //   error: function(response) {
            //     console.log('Error:', response);
            //   }
            });
            });

            // add event listener for form submit
            $('#delete').submit(function(e) {
            e.preventDefault(); // prevent default form submission behavior
        
            // get passwords input value
            const delete_password = $('#delete_password').val();
            // create AJAX request
            $.ajax({
                type: 'POST',
                url: '',
                headers: {
                'X-CSRFToken': '{{ csrf_token }}'
                },
                data: {
                'delete_password': delete_password,
                'delete': true
                },
                dataType: 'json',
                success: function(response) {
                    const delete_invalid = document.getElementById("delete_invalid");
                    if (response.successfully == false){
                        delete_invalid.classList.add("invalid3");
                    } else{
                        window.location.href = "{% url 'home' %}";
                    }

                },
            //   error: function(response) {
            //     console.log('Error:', response);
            //   }
            });
            });
        });
    </script>
</body>
</html>